<!DOCTYPE html>
<html lang="fa-ir">
<head>

  <meta charset="utf-8" />

  
  <title>۳۰ روز با TDD: روز دوازدهم - کار با Stub ها</title>

  
  




  
  <meta name="author" content="حامد سعیدی فرد" />
  <meta name="description" content="نوشته به زبان انگلیسی روز دوازدهم را در این آدرس می‌توانید مطالعه کنید. در نوشته قبلی این سری یک پروتوتایپ از اینکه PlaceOrder برای یک OrderService در یک برنامه e-commerce چطور باید باشد به شما نشان دادم. برای نمایش mocking ما یک نسخه کاربردی از این منطق تجاری (business logic) را با TDD پیاده‌سازی خواهیم کرد. این به آن معنی است که با یک نیازمندی تجاری شروع می‌کنیم:
تصور کنید که کاربر به برنامه وارد شده (login کرده است) و آیتم‌هایی را در سبد خرید قرار داده است." />

  
  
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@hamed" />
    <meta name="twitter:title" content="۳۰ روز با TDD: روز دوازدهم - کار با Stub ها" />
    <meta name="twitter:description" content="نوشته به زبان انگلیسی روز دوازدهم را در این آدرس می‌توانید مطالعه کنید. در نوشته قبلی این سری یک پروتوتایپ از اینکه PlaceOrder برای یک OrderService در یک برنامه e-commerce چطور باید باشد به شما نشان دادم. برای نمایش mocking ما یک نسخه کاربردی از این منطق تجاری (business logic) را با TDD پیاده‌سازی خواهیم کرد. این به آن معنی است که با یک نیازمندی تجاری شروع می‌کنیم:
تصور کنید که کاربر به برنامه وارد شده (login کرده است) و آیتم‌هایی را در سبد خرید قرار داده است." />
    <meta name="twitter:image" content="https://elmah.ir/oldimg/tdd_cycle.jpg" />
  




<meta name="generator" content="Hugo 0.62.2" />


<link rel="canonical" href="https://elmah.ir/post/107-%DB%B3%DB%B0-%D8%B1%D9%88%D8%B2-%D8%A8%D8%A7-tdd-%D8%B1%D9%88%D8%B2-%D8%AF%D9%88%D8%A7%D8%B2%D8%AF%D9%87%D9%85-%DA%A9%D8%A7%D8%B1-%D8%A8%D8%A7-stub-%D9%87%D8%A7/" />
<link rel="alternative" href="https://elmah.ir/index.xml" title="elmah" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />







<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="elmah" />
<meta name="msapplication-tooltip" content="elmah" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="https://elmah.ir/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="https://elmah.ir/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://elmah.ir/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="https://elmah.ir/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="https://elmah.ir/img/touch-icon-apple.png" />
<link rel="mask-icon" href="https://elmah.ir/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="https://elmah.ir/css/bundle.css" />
<link rel="stylesheet" href="https://elmah.ir/css/elmah.css" />

  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
      
    </div>
    
    
<header class="site-header">
  <img class="avatar" src="https://avatars1.githubusercontent.com/u/1385656?s=460&amp;v=4" alt="Avatar">
  
  <h2 class="title">elmah</h2>
  
  <p class="subtitle">~ یادداشت‌های یک برنامه‌نویس خوشحال ~</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item  is-active"><a href="https://elmah.ir/">صفحه نخست</a></li>
      
        <li class="menu-item "><a href="https://elmah.ir/series/">نوشته‌های دنباله‌دار</a></li>
      
        <li class="menu-item "><a href="https://hameds.github.io/slides/">پرزنت‌های من</a></li>
      
        <li class="menu-item "><a href="https://elmah.ir/about/">درباره من</a></li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      

      
      <li class="social-item">
        <a href="//github.com/hameds" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      <li class="social-item">
        <a href="//twitter.com/hamed" title="Twitter"><span class="icon icon-twitter"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="https://elmah.ir/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

<section class="main post-detail">
  <header class="post-header">
    <h1 class="post-title">۳۰ روز با TDD: روز دوازدهم - کار با Stub ها</h1>
    <p class="post-meta">
      @حامد سعیدی فرد ·
      7 دقیقه خواندن</p>
  </header>
  <article class="post-content"><p>نوشته به زبان انگلیسی روز دوازدهم را در <a href="http://blogs.telerik.com/james-bender/posts.aspx/13-10-07/30-days-of-tdd-day-12-working-with-stubs">این آدرس</a> می‌توانید مطالعه کنید. در <a href="https://elmah.ir/post/94-%DB%B3%DB%B0-%D8%B1%D9%88%D8%B2-%D8%A8%D8%A7-tdd--%D8%B1%D9%88%D8%B2-%DB%8C%D8%A7%D8%B2%D8%AF%D9%87%D9%85---%D8%AF%D8%B1%D8%A8%D8%A7%D8%B1%D9%87-mocking/">نوشته قبلی</a> این سری یک پروتوتایپ از اینکه PlaceOrder برای یک OrderService در یک برنامه e-commerce چطور باید باشد به شما نشان دادم. برای نمایش mocking ما یک نسخه کاربردی از این منطق تجاری (business logic) را با TDD پیاده‌سازی خواهیم کرد. این به آن معنی است که با یک نیازمندی تجاری شروع می‌کنیم:</p>
<p>تصور کنید که کاربر به برنامه وارد شده (login کرده است) و آیتم‌هایی را در سبد خرید قرار داده است. برنامه باید این قابلیت را به کاربر بدهد که بر اساس آیتم‌های داخل سبد خرید یک سفارش را ثبت کند. کاربران باید بتوانند هر تعداد دلخواه از آیتم‌ها را سفارش دهند. کاربران نباید تعداد صفر یا کمتر از صفر هر یک از آیتم‌ها را سفارش دهند. اگر کاربری تعداد صفر یا کمتر از صفر را برای محصولی انتحاب کند برنامه باید یک استثناء (Exception) ایجاد کند و کل سفارش باید لغو شود (بدون اینکه سبد خرید خالی شود) به محض اینکه اعتبارسنجی تعداد کالاها انجام شد، سفارش باید در دیتابیس از طریق سرویس مربوطه ذخیره شده و مشتری هم به آن مرتبط شود. فراخوانی‌های سیستم فاکتور و ارسال سفارش بر اساس گردش کار ‌آن‌ها باید انجام شود. یک رکورد لاگ باید ایجاد شود که مشخص کند سفارش ثبت شده است. اگر سفارش به هر دلیلی غیر از اعتبارسنجی تعداد کالای سفارش داده شده ثبت نشود باید خطا لاگ شده و exception ایجاد شود. بعد از ثبت موفق سفارش، سبد خرید خالی شده و شناسه سفارش (order id) باید از دیتابیس برگردانده شود.</p>
<p>این یک نیازمندی تجاری (business requirement) طولانی است. طبیعتاً باعث می‌شود که چندین unit test بنویسیم ولی اجازه بدهید با ساده‌ترینشان شروع کنیم:</p>
<p>وقتی کاربر تلاش می‌کند که کالایی با تعداد بزرگتر از صفر را سفارش دهد، شناسه سفارش باید برگردانده شود.</p>
<p>این یک مورد ساده و در عین حال یک شروع خوب است. چون این اولین نیازمندی و اولین تست است، من هیچ کد یا حتی solution ای در Visual Studio ندارم. برای شروع من یک Solution خالی در Visual Studio برای پروژه‌ام ایجاد می‌کنم که TddStore نام دارد. سپس یک پروژه به نام TddStore.UnitTests برای تست‌ها ایجاد می‌کنیم و از Nuget برای ایجاد رفرنس به NUnit در پروژه TddStore.UnitTests استفاده می‌کنم. نحوه رفرنس دادن را در <a href="https://elmah.ir/post/80-30-%D8%B1%D9%88%D8%B2-%D8%A8%D8%A7-tdd--%D8%B1%D9%88%D8%B2-%D8%B3%D9%88%D9%85---%D8%A7%D9%88%D9%84%DB%8C%D9%86-%D8%AA%D8%B3%D8%AA-%D8%B4%D9%85%D8%A7/">روز سوم</a> یاد گرفتیم. بعد از تکمیل این مراحل Solution من اینطور باید به نظر برسد</p>
<p><img src="https://elmah.ir/oldimg/image_thumb2.png" alt=""></p>
<p>کلاس Class1 را به OrderServiceTests تغییر نام می‌دهیم. از خواص (attribute) مربوط به NUnit برای نوشتن اولین تست استفاده می‌کنیم</p>
<script type="application/javascript" src="https://gist.github.com/hameds/858d113a11dcad884f10e077b35f68ed.js"></script>

<p>در این مثال فرض می‌کنیم تیم دیگری نیز بر روی برنامه در حال کار است و پیاده‌سازی ShoppingCart و Order و همچنین Interface های OrderDataService و BillingService و FulfillmentService  و LoggingService را در یک پروژه class library انجام داده است. این پروژه که TddStore.Core نام دارد را با استفاده از <a href="https://skydrive.live.com/?cid=DE4AEBF19948423F&amp;id=DE4AEBF19948423F%2112673">این فایل‌ها</a> می‌توانید ایجاد کنید. بعد از ایجاد پروژه TddStore.Core باید رفرنس آن را به پروژه TddStore.UnitTests اضافه کنید.</p>
<p>برای این تست من نیاز دارم که با فراخوانی متدی که باید پیاده‌سازی شود از کلاسی که باید پیاده‌سازی شود یک سفارش ثبت کنم. مطابق معمول گردش کار TDD ابتدا تست را می‌نویسیم:</p>
<script type="application/javascript" src="https://gist.github.com/hameds/e434d112eea6a6cba113eb106f5dc056.js"></script>

<p>فهمیدن کد این تست باید خیلی ساده باشد. در قسمت Arrange من یک وهله (instance) از سبد خرید ایجاد می‌کنم و به آن یک آیتم اضافه می‌کنم. همچنین یک سفارش و شناسه مشتری فرضی برای تستم ایجاد می‌کنم. در نهایت یک OrderService برای تست ایجاد می‌کنم.</p>
<p>دو بخش Act و Assert هم نیازی به توضیح خاصی ندارند و مراحل ثبت سفارش و دریافت شناسه مورد آزمون قرار می‌گیرند. در این مرحله من تست را اجرا می‌کنم تا fail شدنش را ببینم و سپس شروع به نوشتن ساده‌ترین کد ممکن برای pass شدن تست می‌کنم. در نهایت به این کد می‌رسم:</p>
<script type="application/javascript" src="https://gist.github.com/hameds/27bfcc868ce8d049f1d2fdfead7d5ae3.js"></script>

<p>بر اساس شرایط من باید رفرنس به OrderDataService ایجاد کنم. کد را refactor کرده و از طریق تزریق وابستگی با سازنده آن را تغییر می‌دهم</p>
<script type="application/javascript" src="https://gist.github.com/hameds/c449d4a51b8674a7540f514efdfc52d4.js"></script>

<p>من به متد PlaceOrder دسترسی به instance ای از کلاس OrderDataService (از طریق اینترفیس IOrderDataService) می‌دهم ولی الان تست من دیگر کامپایل نمی‌شود. دلیل آن این است که سازنده (Constructor) پیش فرض OrderService دیگر وجود ندارد، نیاز است تا چیزی که IOrderDataService را پیاده‌سازی کرده به OrderService پاس بدهم</p>
<p><strong>قدم بعدی</strong></p>
<p>همان‌طور که در نوشته‌های قبلی اشاره شد از JustMock شرکت Telerik استفاده می‌کنیم. می‌توانید نسخه Lite آن را از طریق Nuget به پروژه اضافه کنید.</p>
<p>حالا که به JustMock دسترسی داریم، یک stub برای IOrderDataService ایجاد می‌کنیم:</p>
<script type="application/javascript" src="https://gist.github.com/hameds/f8beb0f738f74741c7f1084b122a776c.js"></script>

<p>اولین مرحله ایجاد شی mock است. قبل از این کار باید با استفاده از using فضانام Telerik.JustMock را به کلاس اضافه کنید. در خط ۲۱ من یک شی mock شده از اینترفیس IOrderDataService ایجاد کردم. چون این شی IOrderDataService را پیاده‌سازی می‌کند می‌توانم به عنوان آرگومان سازنده آن را به OrderService پاس بدهم همانطور که در خط ۲۲ می‌بینید. در ادامه کمی کد به متد PlaceOrder در کلاس OrderService اضافه می‌کنیم تا از IOrderDataService استفاده کند.</p>
<script type="application/javascript" src="https://gist.github.com/hameds/089f9ce11dd7eb557606f57ce8901270.js"></script>

<p>بر اساس تست کیس ما تنها نیاز داریم که به متد تست یک سبد خرید با حداقل یک آیتم پاس بدهیم و یک شناسه سفارش تحویل بگیریم. در این تست کیس هیچ توضیحی درباره اینکه اگر اعتبارسنجی به مشکل بخورد یا اینکه چطور بر اساس سبد خرید یک سفارش بسازیم وجود ندارد. unit test جاری پاسخگوی تست کیس تعریف شده است.</p>
<p>ما هنوز (و البته همیشه) در فازی هستیم که ساده‌ترین کد ممکن برای پاس شدن تست‌ها را بنویسیم. در این مرحله شما احتمالاً چند سوال خواهید داشت. اعتبارسنجی چطور انجام می‌شود؟ چطور مطمئن شویم که وهله (instance) سفارشی که ساخته شده درست ساخته شده است؟ جواب هر دو این سوالات این است که برای انجام نیازمندی‌های جدید باید تست بیشتری بنوسیم. وقتی تست‌ها را نوشتیم حالا می‌توانیم کد بنویسیم. این مساله را در نوشته‌های بعدی این سری خواهیم دید.</p>
<p>در این مرحله تست‌ها را دوباره اجرا می‌کنیم. تست باید fail شود چرا که با وجود اینکه همه وابستگی‌های مورد نیاز را تامین کردم، هنوز شناسه سفارش مورد انتظار را دریافت نمی‌کنم.</p>
<p><img src="https://elmah.ir/oldimg/image_thumb10510802A18A1.png" alt=""></p>
<p>گرچه یک شی mock شده برای OrderDataService ایجاد کردیم اما هنوز نگفتیم وقتی فراخوانی شد چه کار باید انجام دهد. با اشاره به لیست انواع mock ها که در نوشته قبلی توضیح داده شدند، آنچه الان داریم یک Dummy است. ما باید آن را به یک Stub واقعی ارتقاء دهیم.</p>
<script type="application/javascript" src="https://gist.github.com/hameds/ff5a6f1ea5f7d84f43aa6167f820519c.js"></script>

<p>در خط ۱۴ من از دستور Mock.Arrange برای setup کردن شی mock شده orderDataService استفاده می‌کنم که در واقع این شی را به یک stub تبدیل می‌کند. متد Arrange یک عبارت Linq می‌گیرد که مشخص می‌کند برای کدام متد می‌خواهم رفتار تعریف کنم. در این مثال من به stub می‌گویم که به فراخوانی متد Save پاسخ دهد. به عنوان بخشی از این عبارت Linq می‌توانم یک لیست پارامتر برای stub تعریف کنم. می‌توانم یک مقدار مشخص را تعیین کنم. به عنوان مثال، اگر متد Save یک int بگیرد، می‌توانم مشخص کنم فقط زمانی که مقدار ۴۲ پاس داده می‌شود پاسخ بررسی شود. اگر mock را با مقداری غیر ز ۴۲ فراخوانی کنم مقدار پیش فرض آن نوع داده بازگشتی (مثلاً صفر برای int) را برمی‌گرداند. به این دلیل بود که وقتی قبلاً تست‌ها را اجرا کردم شی mock شده orderDataService یک guid خالی (همه صفر) برگرداند. این موضوع که loose mocking نیز نامیده می‌شود در نوشته‌های بعدی مورد بررسی قرار خواهد گرفت.</p>
<p>در این مثال من یک وهله (instance) از شی Order را پاس می‌دهم و از Matcher استفاده می‌کنیم. Matcher در واقع روشی است که به یک arrangement بگوییم نگران مشخصات پارامترها نباشد. من فقط می‌خواهم یک رفتار برای پارامترها تعریف کنم که از یک الگوی خاص پیروی می‌کنند. در این مثال به JustMock می‌گویم که فقط پاس داده شن شی Order برایم مهم است. برایم مهم نیست از کجا می‌آید یا چه چیزی داخلش است. Matcher ها ابزار قدرتمندی در mocking هستند که در نوشته‌های بعدی به آن اشاره خواهم کرد. حالا اگر تست را دوباره اجرا کنم pass می‌شود.</p>
<p><img src="https://elmah.ir/oldimg/image_thumb3596437C16CCF.png" alt=""></p>
<p>ادامه دارد&hellip;</p>
</article>
  <footer class="post-footer">
    
    <p class="post-copyright">
      این
      نوشته <strong>1973</strong> روز پیش منتشر شده و محتوای آن ممکن است برای
      امروز، غیردقیق یا حتی اشتباه باشد. اگر اشتباهی دیدید لطفاً در گیت‌هاب اعلام یا رفعش کنید.
    </p>
  </footer>
  <hr>
  <div id="graphcomment"></div>
  <script type="text/javascript">

     

    
    window.gc_params = {
      graphcomment_id: 'elmah',

      
      fixed_header_height: 0,
    };

     


    (function () {
      var gc = document.createElement('script'); gc.type = 'text/javascript'; gc.async = true;
      gc.src = 'https://graphcomment.com/js/integration.js?' + Math.round(Math.random() * 1e8);
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(gc);
    })();

  </script>

  
  
  
</section>
<footer class="site-footer">
  <p>© 2017-2020 elmah</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\[','\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="https://elmah.ir/js/bundle.js"></script>




  </body>
</html>

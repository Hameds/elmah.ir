<!DOCTYPE html>
<html lang="fa-ir">
<head>

  <meta charset="utf-8" />

  
  <title>۳۰ روز با TDD: روز هفدهم-تعیین ترتیب اجرا در mock ها</title>

  
  




  
  <meta name="author" content="حامد سعیدی فرد" />
  <meta name="description" content="امروز هم توسعه برنامه فروشگاهی که به روش TDD نوشتیم را با نگاهی نزدیک‌تر به سرویس Order Fulfillment که یک سرویس خارج از برنامه اصلی است، ادامه می‌دهیم.
ارسال سفارش
اگر نوشته قبلی را خوانده باشید، به یاد دارید که ما با یک سرویس خارج از برنامه اصلی برای اجرای سفارشات کار می‌کردیم. آن‌ها یک API فراهم کرده‌اند و ما OrderFulfillmentService را فراخوانی می‌کنیم. interface این API چندین فراخوانی و مجموعه‌ای از قوانین برای ترتیب فراخوانی‌ها دارد." />

  
  
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@hamed" />
    <meta name="twitter:title" content="۳۰ روز با TDD: روز هفدهم-تعیین ترتیب اجرا در mock ها" />
    <meta name="twitter:description" content="امروز هم توسعه برنامه فروشگاهی که به روش TDD نوشتیم را با نگاهی نزدیک‌تر به سرویس Order Fulfillment که یک سرویس خارج از برنامه اصلی است، ادامه می‌دهیم.
ارسال سفارش
اگر نوشته قبلی را خوانده باشید، به یاد دارید که ما با یک سرویس خارج از برنامه اصلی برای اجرای سفارشات کار می‌کردیم. آن‌ها یک API فراهم کرده‌اند و ما OrderFulfillmentService را فراخوانی می‌کنیم. interface این API چندین فراخوانی و مجموعه‌ای از قوانین برای ترتیب فراخوانی‌ها دارد." />
    <meta name="twitter:image" content="https://elmah.ir/oldimg/tdd_cycle.jpg" />
  




<meta name="generator" content="Hugo 0.62.2" />


<link rel="canonical" href="https://elmah.ir/post/122-%DB%B3%DB%B0-%D8%B1%D9%88%D8%B2-%D8%A8%D8%A7-tdd-%D8%B1%D9%88%D8%B2-%D9%87%D9%81%D8%AF%D9%87%D9%85-%D8%AA%D8%B9%DB%8C%DB%8C%D9%86-%D8%AA%D8%B1%D8%AA%DB%8C%D8%A8-%D8%A7%D8%AC%D8%B1%D8%A7-%D8%AF%D8%B1-mock-%D9%87%D8%A7/" />
<link rel="alternative" href="https://elmah.ir/index.xml" title="elmah" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />







<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="elmah" />
<meta name="msapplication-tooltip" content="elmah" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="https://elmah.ir/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="https://elmah.ir/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://elmah.ir/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="https://elmah.ir/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="https://elmah.ir/img/touch-icon-apple.png" />
<link rel="mask-icon" href="https://elmah.ir/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="https://elmah.ir/css/bundle.css" />
<link rel="stylesheet" href="https://elmah.ir/css/elmah.css" />

  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
      
    </div>
    
    
<header class="site-header">
  <img class="avatar" src="https://avatars1.githubusercontent.com/u/1385656?s=460&amp;v=4" alt="Avatar">
  
  <h2 class="title">elmah</h2>
  
  <p class="subtitle">~ یادداشت‌های یک برنامه‌نویس خوشحال ~</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item  is-active"><a href="https://elmah.ir/">صفحه نخست</a></li>
      
        <li class="menu-item "><a href="https://elmah.ir/series/">نوشته‌های دنباله‌دار</a></li>
      
        <li class="menu-item "><a href="https://hameds.github.io/slides/">پرزنت‌های من</a></li>
      
        <li class="menu-item "><a href="https://elmah.ir/about/">درباره من</a></li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      

      
      <li class="social-item">
        <a href="//github.com/hameds" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      <li class="social-item">
        <a href="//twitter.com/hamed" title="Twitter"><span class="icon icon-twitter"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="https://elmah.ir/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

<section class="main post-detail">
  <header class="post-header">
    <h1 class="post-title">۳۰ روز با TDD: روز هفدهم-تعیین ترتیب اجرا در mock ها</h1>
    <p class="post-meta">
      @حامد سعیدی فرد ·
      4 دقیقه خواندن</p>
  </header>
  <article class="post-content"><p>امروز هم توسعه برنامه فروشگاهی که به روش TDD نوشتیم را با نگاهی نزدیک‌تر به سرویس Order Fulfillment که یک سرویس خارج از برنامه اصلی است، ادامه می‌دهیم.</p>
<p><strong>ارسال سفارش</strong></p>
<p>اگر نوشته قبلی را خوانده باشید، به یاد دارید که ما با یک سرویس خارج از برنامه اصلی برای اجرای سفارشات کار می‌کردیم. آن‌ها یک API فراهم کرده‌اند و ما OrderFulfillmentService را فراخوانی می‌کنیم. interface این API چندین فراخوانی و مجموعه‌ای از قوانین برای ترتیب فراخوانی‌ها دارد. خلاصه‌ای از این interface را در کد زیر می‌توانید ببینید:</p>
<script type="application/javascript" src="https://gist.github.com/hameds/fc5370bdcfb2c59896e688f067babe7e.js"></script>

<p>می‌توانیم درباره کارآیی این interface بحث کنیم، اما به هر حال این interface ای است که شریک اجرایی ما از آن استفاده می‌کند و بنابراین ما هم باید از همین interface استفاده کنیم. چند قانون پیرامون گردش کار این API وجود دارد:</p>
<ul>
<li>کاربر باید برای هر سفارش از یک session استفاده کند</li>
<li>کاربر برای باز کردن session باید نام کاربری و کلمه عبور خود را ارائه دهد</li>
<li>همه فراخوانی‌های سرویس باید شامل شناسه (id) مربوط به session باشند</li>
<li>کاربر باید تایید کند که همه اقلام سفارش، قبل از ثبت سفارش در انبار وجود دارد. ثبت سفارش اقلامی که در انبار نیستند باعث شکست ثبت سفارش می‌شود</li>
<li>کاربر باید session را به جهت تکمیل سفارش خاتمه دهد</li>
<li>شناسه session کد رهگیری سفارش خواهد بود</li>
</ul>
<p>چند قید (constraint) در این قوانین وجود دارد که باید روی آن‌ها کار کنیم. در نوشته امروز به همه آن‌ها نخواهیم پرداخت، اما روی ترتیب عملیات مربوط به این قیدها کار خواهم کرد. اولین چیزی که نیاز داریم یک تست کیس (test case) است</p>
<p>وقتی که سفارشی ثبت می‌شود که در انبار موجود است، گردش کار اجرای سفارش باید کامل شود</p>
<p>درست است. این یک تست کیس بسیار ساده است. این تست روی هدف نوشته امروز بسیار متمرکز شده، که در واقع اطمینان از این مطلب است که فراخوانی‌های OrderFulfillment به ترتیب انجام شوند.</p>
<script type="application/javascript" src="https://gist.github.com/hameds/a160393dec77894c05bb42c7febbbe07.js"></script>

<p>این‌ها موارد ابتدایی فراخوانی PlaceOrder در OrderService هستند همانطور که در نوشته قبلی اشاره کردم، باید برای دریافت اطلاعات مشتری (از جمله آدرس وی) CustomerService را فراخوانی کنم. حالا به arrange کردن mock نیازمندم. تغییر کوچکی در arrange فعلی انجام می‌دهم و بخش Act را با فراخوانی متد PlaceOrder از OrderService می‌سازم.</p>
<script type="application/javascript" src="https://gist.github.com/hameds/46c152286eca1c0b851f25cfb7060f36.js"></script>

<p>بیشتر کدی که نوشتم باید واضح باشد. در خط ۱۰ ، مقداری جهت ایجاد و گرفتن session id مربوط به تکمیل سفارش اضافه کردم و در خط ۲۲ اجرای صحیح mock را assert کردم. نکته جالب این کد در خط ۱۶ است که ثابت InOrder را اضافه کردم. بخش arrange کد را تکمیل می‌کنیم:
<script type="application/javascript" src="https://gist.github.com/hameds/a597bd6654a4ece137cc4a71bd0bcfba.js"></script>
</p>
<p>در کد بالا، در خط‌های ۱۴ تا ۲۶ من mock برای OrderFulfillmentService را arrange می‌کنم. نگران نباشید و حواستان با لیست پارامترهای mock پرت نشود، با ایجاد سفارشی این پارامترها در نوشته بعدی آشنا خواهیم شد. الان فقط روی ترتیب متدها متمرکز می‌شویم. متوجه شدید که mock ها را به ترتیبی که می‌خواهم متدها اجرا شوند arrange کرده‌ام. OpenSession –&gt; IsInInventory –&gt; PlaceOrder –&gt; CloseSession اگر برای فراخوانی این‌ها به ترتیب دیگری عمل کنم، تست من موقع فراخوانی MockAssert حتماً fail خواهد شد.</p>
<p>اگر برای اجرای این تست تلاش کنم، خطای کامپایلر برای عدم تعریف _orderFulfillmentService دریافت می‌کنم. تا اینجای کار به سرویس OrdeFulfillment نیازی نداشتم ولی حالا به mock نیاز دارم:</p>
<script type="application/javascript" src="https://gist.github.com/hameds/6cc6aa927aa2027fd272a58b9c3e18e9.js"></script>

<p>بسیار خب. نوبت اجرای تست رسیده</p>
<p><img src="https://elmah.ir/oldimg/image_thumb1c375162e4819-png.png" alt=""></p>
<p>تست ما fail شد چرا که هیچیک از متدهای OrderFulfillmentService  فراخوانی نشده‌اند. قدم بعدی، پیاده‌سازی کد برای این تست است</p>
<script type="application/javascript" src="https://gist.github.com/hameds/5652c1ec29b7e418a07fa78283ff4c4e.js"></script>

<p>در خط ۱۴ شروع کردم به کار با OrderFulFillmentService و برای اینکه بدانیم در هر مرحله چه کاری انجام می‌شود در کد، توضیح (comment) گذاشته‌ام. حالا توجه کنید که گام‌های فراخوانی من به ترتیب مورد انتظار نیست. من از باز کردن session مستقیماً به سفارش می‌روم به جای اینکه اول موجودی انبار را چک کنم. می‌توانم تلاش کنم تست را اجرا کنم ولی به دلیل نبود وهله (instance) از OrderFulfillmentService خطای کامپایل دریافت می‌کنم، همچنین سازنده کلاس را برای تزریق وابستگی به روز نکرده‌ام. حالا این دو مشکل را حل می‌کنم. در حالی که در مشغول این کار هستم، ثابت‌های نام کاربری و کلمه عبور را هم تعریف می‌کنم</p>
<script type="application/javascript" src="https://gist.github.com/hameds/db5b261bad18a83dcd5e561636f2f764.js"></script>

<p>تلاش برای اجرای کد، به خطاهای کامپایل بیشتری منجر می‌شود چرا که تست من برای تزریق mock مربوط به OrderFulFillmentService  به عنوان سومین آرگومان OrderService به روز نشده. این به روز رسانی را هم انجام می‌دهم</p>
<script type="application/javascript" src="https://gist.github.com/hameds/b3e5420924c1139dbf1c39cf83053585.js"></script>

<p>برنامه در نهایت کامایل می‌شود. حالا نوبت اجرای تست است و مجدداً fail می‌شود!</p>
<p><img src="https://elmah.ir/oldimg/image_thumb34c376676497f-png.png" alt=""></p>
<p>این نتیجه غیرمنتظره نبود، اگر به یاد داشته باشید به عمد متدها را با ترتیب غیرصحیحی در OrderFulfillmentService فراخوانی کردم. نرم‌افزار (در این سری نوشته‌ها JustMock) به ما می‌گوید که ترتیب فراخوانی متدها صحیح نیست و لیست ترتیب فراخوانی را هم نشان می‌دهد. با جابجایی فراخوانی متدها به کد زیر می‌رسیم:</p>
<script type="application/javascript" src="https://gist.github.com/hameds/e3d9b0d284b4baee264eabdbfa98574f.js"></script>

<p>نوبت اجرای مجدد تست است.</p>
<p><img src="https://elmah.ir/oldimg/image_thumb5c55c855dada5-png.png" alt=""></p>
<p>با اطمینان یافتن از اینکه متدها با ترتیب درستی فراخوانی می‌شوند، می‌توانم مطمئن شوم که تستم pass خواهد شد.</p>
<p>ادامه دارد &hellip;</p>
</article>
  <footer class="post-footer">
    
    <p class="post-copyright">
      این
      نوشته <strong>1544</strong> روز پیش منتشر شده و محتوای آن ممکن است برای
      امروز، غیردقیق یا حتی اشتباه باشد. اگر اشتباهی دیدید لطفاً در گیت‌هاب اعلام یا رفعش کنید.
    </p>
  </footer>
  <hr>
  <div id="graphcomment"></div>
  <script type="text/javascript">

     

    
    window.gc_params = {
      graphcomment_id: 'elmah',

      
      fixed_header_height: 0,
    };

     


    (function () {
      var gc = document.createElement('script'); gc.type = 'text/javascript'; gc.async = true;
      gc.src = 'https://graphcomment.com/js/integration.js?' + Math.round(Math.random() * 1e8);
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(gc);
    })();

  </script>

  
  
  
</section>
<footer class="site-footer">
  <p>© 2017-2020 elmah</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\[','\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="https://elmah.ir/js/bundle.js"></script>




  </body>
</html>

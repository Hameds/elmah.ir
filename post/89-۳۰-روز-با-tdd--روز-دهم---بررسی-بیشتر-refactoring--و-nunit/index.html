<!DOCTYPE html>
<html lang="fa-ir">
<head>

  <meta charset="utf-8" />

  
  <title>۳۰ روز با TDD: روز دهم - بررسی بیشتر Refactoring‌ و NUnit</title>

  
  




  
  <meta name="author" content="حامد سعیدی فرد" />
  <meta name="description" content="در نوشته روز نهم، درباره Refactoring صحبت کردیم، نوشته به زبان انگلیسی روز دهم را در این آدرس می‌توانید مطالعه کنید. در روز دهم با امکانات بیشتری در NUnit و همچنین Refactoring آشنا خواهیم شد.
بهترین شمشیرها از هر دو طرف می‌برند نه تنها مهم است که به صورت دوره‌ای کد business logic خودمان را refactor کنیم، بلکه لازم است به صورت دوره‌ای تست‌ها را نیز بررسی کنیم. به یاد داشته باشید که تست‌ها هم نوعی کد هستند و نیازمند نگهداری مشابه." />

  
  
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@hamed" />
    <meta name="twitter:title" content="۳۰ روز با TDD: روز دهم - بررسی بیشتر Refactoring‌ و NUnit" />
    <meta name="twitter:description" content="در نوشته روز نهم، درباره Refactoring صحبت کردیم، نوشته به زبان انگلیسی روز دهم را در این آدرس می‌توانید مطالعه کنید. در روز دهم با امکانات بیشتری در NUnit و همچنین Refactoring آشنا خواهیم شد.
بهترین شمشیرها از هر دو طرف می‌برند نه تنها مهم است که به صورت دوره‌ای کد business logic خودمان را refactor کنیم، بلکه لازم است به صورت دوره‌ای تست‌ها را نیز بررسی کنیم. به یاد داشته باشید که تست‌ها هم نوعی کد هستند و نیازمند نگهداری مشابه." />
    <meta name="twitter:image" content="https://elmah.ir/oldimg/tdd_cycle.jpg" />
  




<meta name="generator" content="Hugo 0.49" />


<link rel="canonical" href="https://elmah.ir/post/89-%DB%B3%DB%B0-%D8%B1%D9%88%D8%B2-%D8%A8%D8%A7-tdd--%D8%B1%D9%88%D8%B2-%D8%AF%D9%87%D9%85---%D8%A8%D8%B1%D8%B1%D8%B3%DB%8C-%D8%A8%DB%8C%D8%B4%D8%AA%D8%B1-refactoring--%D9%88-nunit/" />
<link rel="alternative" href="https://elmah.ir/index.xml" title="elmah" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />







<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="elmah" />
<meta name="msapplication-tooltip" content="elmah" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="https://elmah.ir/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="https://elmah.ir/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="https://elmah.ir/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="https://elmah.ir/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="https://elmah.ir/img/touch-icon-apple.png" />
<link rel="mask-icon" href="https://elmah.ir/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="https://elmah.ir/css/bundle.css" />
<link rel="stylesheet" href="https://elmah.ir/css/elmah.css" />

  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="https://avatars1.githubusercontent.com/u/1385656?s=460&amp;v=4" alt="Avatar">
  
  <h2 class="title">elmah</h2>
  
  <p class="subtitle">~ یادداشت‌های یک برنامه‌نویس خوشحال ~</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item  is-active"><a href="https://elmah.ir/">صفحه نخست</a></li>
      
        <li class="menu-item "><a href="https://elmah.ir/series/">نوشته‌های دنباله‌دار</a></li>
      
        <li class="menu-item "><a href="https://hameds.github.io/slides/">پرزنت‌های من</a></li>
      
        <li class="menu-item "><a href="https://elmah.ir/about/">درباره من</a></li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      

      
      <li class="social-item">
        <a href="//github.com/hameds" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      <li class="social-item">
        <a href="//twitter.com/hamed" title="Twitter"><span class="icon icon-twitter"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="https://elmah.ir/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">۳۰ روز با TDD: روز دهم - بررسی بیشتر Refactoring‌ و NUnit</h1>
      <p class="post-meta">@حامد سعیدی فرد · 4 دقیقه خواندن</p>
    </header>
    <article class="post-content">

<p>در نوشته روز نهم، درباره Refactoring <a href="https://elmah.ir/post/87-۳۰-روز-با-tdd--روز-نهم---مقدمات-refactoring/">صحبت کردیم</a>، نوشته به زبان انگلیسی روز دهم را در <a href="http://blogs.telerik.com/james-bender/posts.aspx/13-09-30/30-days-of-tdd-day-ten-more-refactoring-and-nunit-features">این آدرس</a> می‌توانید مطالعه کنید. در روز دهم با امکانات بیشتری در NUnit و همچنین Refactoring آشنا خواهیم شد.</p>

<h3 id="بهترین-شمشیرها-از-هر-دو-طرف-می-برند">بهترین شمشیرها از هر دو طرف می‌برند</h3>

<p>نه تنها مهم است که به صورت دوره‌ای کد business logic خودمان را refactor کنیم، بلکه لازم است به صورت دوره‌ای تست‌ها را نیز بررسی کنیم. به یاد داشته باشید که تست‌ها هم نوعی کد هستند و نیازمند نگهداری مشابه. اجازه بدهید نگاهی به تست‌های جاری‌مان داشته باشیم:</p>

<script type="application/javascript" src="//gist.github.com/hameds/d8d055fa0ff8d04c2891c1f9816b00a5.js"></script>

<p>یک نگاه سریع به این کد، یکی از اهداف مشترک refactoring را آشکار می‌کند: تکرار کد. اگر به خط‌های ۱۶ و ۲۹ و ۴۲ نگاه کنید می‌بینید که من مرتباً وهله‌های (instance) جدیدی از کلاس StringUtils برای هر تست ایجاد کردم. در کل من مایل به رعایت اصل <strong>DRY</strong> هستم. DRY سرنام عبارت <strong>D</strong>on&rsquo;t <strong>R</strong>epeat <strong>Y</strong>ourself است. در این مثال من مشخصاً و زمانی که نیازی ندارم در حال تکرار کدم که وهله‌ای از StringUtils ایجاد می‌کند هستم. خوشبختانه NUnit مکانیزم برای کمک به ما برای DRY شدن کدمان فراهم می‌کند.</p>

<p>اما پیش از اینکه به سراغ تغییر تست‌ها برویم، لازم است سوالی را از خودمان بپرسیم: <strong>از کجا باید بدانم که تغییر دادن تست‌ها باعث شکستن آن‌ها نمی‌شود؟</strong>وقتی ما کد business logic برنامه را تغییر می‌دادیم، آزمون‌های واحد (unit test) داشتیم که به ما اطمینان می‌داد نتایج refactoring ما همچنان نیازهای تجاری که بر اساس آزمون‌های واحد تعریف شده‌اند را پوشش می‌دهند. تا زمانی که تست‌ها ما پاس می‌شدند، مطمئن بودیم که business logic همچنان نیازمندی‌های ما را برآورده می‌کند. <br />
اگر واقعاً TDD را تمرین کرده باشیم، یعنی فقط بر اساس تست‌هایمان کد نوشته باشیم (و اول هم تست نوشته باشیم) آنگاه می‌توانیم از business logic برای اعتبارسنجی تست‌هایمان استفاده کنیم. این همان شمشیر دو لبه است و بدان معنی است که می‌توانیم تست‌هایمان refactor کنیم و تا زمانی که تست‌ها همچنان پاس می‌شوند و با شرط آنکه در همین حین business logic را تغییر نداده باشیم، تست‌های ما همچنان معتبر هستند.</p>

<p>در خصوص refactor تست‌ها، کاری که می‌خواهم انجام بدهم این است که کدی بنویسم که وهله‌ای از StringUtils برای استفاده در همه تست‌ها را ایجاد کند. تاثیر واقعی این کار وقتی در نوشته‌های بعدی درباره mocking صحبت کنیم نشان داده خواهد شد. معمولاً این کار را با ایجاد یک متد قابل استفاده مجدد انجام می‌دهم یا در این مورد خاص با استفاده از DI Framework اما NUnit راه بهتری را ممکن می‌کند.</p>

<p>میان ویژگی‌های مختلف NUnit قابلیت تعریف متدهای SetUp وجود دارد. یک متد setup در NUnit با استفاده از خاصیت SetUp به شکل زیر تعریف می‌شود. وقتی یک متد SetUp در یک test fixture در NUnit تعریف می‌شود قبل از اجرای هر تست در آن کلاس test fixture اجرا خواهد شد:</p>

<script type="application/javascript" src="//gist.github.com/hameds/36ca2fcec8ff0a6027dd2b7dcede0d78.js"></script>

<p>من یک متغیر وهله خصوصی (private instance) از نوع StringUtils تعریف کردم و متدی به نام SetupStringUtilsTests ایجاد کردم که در آن وهله جدیدی از کلاس StringUtils‌ را به متغیر خصوصی مربوطه انتساب می‌دهم. قدم بعدی refactor کردن تست‌ها برای استفاده از این متغیر است:</p>

<script type="application/javascript" src="//gist.github.com/hameds/ce89b43b223525f25daf578cfce4f099.js"></script>

<p>اجرای تست‌ها نشان می‌دهد که آن‌ها بعد از این تغییر همچنان پاس می‌شوند</p>

<p><img src="https://elmah.ir/oldimg/image_thumb1ADCD814D3DB6.png" alt="" /></p>

<p>این کار قطعاً تست‌های ما را خواناتر کرده است. همچنین به ما این قابلیت را داده تا کدی که از StringUtils وهله می‌سازد را یک جا کپسوله‌سازی کنیم. در واقع اگر کد ما تغییری کند، ما فقط یک متد را باید تغییر بدهیم نه n تا تست! استفاده از خاصیت SetUp به ما این قابلیت را می‌دهد تا متدهایی را تعریف کنیم که قبل از هر تست اجرا شوند. در شرایطی که کلاس زیر تست ما وضعیتی دارد که هر بار باید قبل از اجرای هر تست مجدداً ایجاد شود، استفاده از SetUp گزینه خوبی است. اما StringUtils ما چنین وضعیتی ندارد و نیازی نیست هر دفعه دوباره از اول ایجاد شود. اینجاست که از می‌توانیم از خاصیت <strong>TestFixtureSetUp</strong>برای setup method خودمان استفاده کنیم. این خاصیت مشابه SetUp عمل می‌کند، اما به جای اجرا پیش از هر تست، یک بار برای هر instance از کلاس test fixture اجرا می‌شود. در مثال ما کلاس test fixture‌ سه تست دارد. در حالی که SetUp باعث اجرای سه مرتبه‌ای وهله‌سازی StringUtils می‌شود، TestFixtureSetUp یک بار برای هر سه تست ما اجرا و از یک وهله مشترک از کلاس StringUtils که توسط setup method ایجاد شده استفاده می‌کند.</p>

<p>از آنجایی که ما هر دفعه به یک وهله جدید از StringUtils نیاز نداریم، کد را برای استفاده از TestFixtureSetUp به شکل زیر تغییر می‌دهیم:</p>

<script type="application/javascript" src="//gist.github.com/hameds/8e1d5103c58b31525f4309898f245f1f.js"></script>

<p>تست‌ها را دوباره اجرا می‌کنیم تا مطمئن شویم refactor اخیر ما چیزی را خراب نکرده باشد.</p>

<p><img src="https://elmah.ir/oldimg/image_thumb1ADCD814D3DB6.png" alt="" /></p>

<p>آخرین نکته درباره SetUp و TestFixtureSetUp‌ این است که NUnit فقط یک وهله از این خاصیت‌ها را در هر test fixture پشتیبانی می‌کند. شما می‌توانید از هر کدام یکی در test fixture خود داشته باشید اما مثلاً امکان مزین کردن دو متد با SetUp وجود ندارد. این کار موقع کامپایل خطایی به شما نمی‌دهد، اما در صورت تخطی، NUnit نمی‌تواند تست‌های شما را اجرا کند.</p>

<p>ادامه دارد&hellip;</p>
</article>
    <footer class="post-footer">
      
      <p class="post-copyright">       
        این نوشته  <strong>1755</strong> روز پیش منتشر شده و محتوای آن ممکن است برای امروز، غیردقیق یا حتی اشتباه باشد. اگر اشتباهی دیدید لطفاً در گیت‌هاب اعلام یا رفعش کنید.
      </p>
    </footer>
    <hr>
    <div id="darinternet_comment"></div>
    <script type="text/javascript">    
      (function () {
        var cmt = document.createElement('script');
        cmt.type = 'text/javascript';
        cmt.async = true;
        cmt.src = 'https://www.darinternet.com/script/commentscript/ccc91a81-b2c4-e711-90f9-005056000124';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(cmt);
      })();
    </script>
    
    
      
    
  </section>
  <footer class="site-footer">
  <p>© 2017-2019 elmah</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\[','\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="https://elmah.ir/js/bundle.js"></script>




  </body>
</html>

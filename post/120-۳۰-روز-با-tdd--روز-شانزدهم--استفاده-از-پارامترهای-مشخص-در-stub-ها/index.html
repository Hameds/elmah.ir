<!DOCTYPE html>
<html lang="fa-ir">
<head>

  <meta charset="utf-8" />

  
  <title>۳۰ روز با TDD: روز شانزدهم- استفاده از پارامترهای مشخص در Stub ها</title>

  
  




  
  <meta name="author" content="حامد سعیدی فرد" />
  <meta name="description" content="ما مثال چند نوشته قبلی این سری نوشته‌ها را پی خواهیم گرفت. نیازمندی نرم‌افزاری را در روز دوازدهم از Stub بیان کردیم. به عنوان بخشی از این نیازمندی، ما باید با یک سیستم ثبت سفارش خارجی ارتباط برقرار کنیم. تست کیس بعدی که می‌خواهم به آن بپردازم مربوط به همین ارتباط با سیستم خارجی ثبت سفارش است. به جای اینکه خودمان بخش ثبت سفارش را بنویسیم، مدیریت تصمیم گرفته که آن را برون‌سپاری (outsource) کنیم." />

  
  
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@hamed" />
    <meta name="twitter:title" content="۳۰ روز با TDD: روز شانزدهم- استفاده از پارامترهای مشخص در Stub ها" />
    <meta name="twitter:description" content="ما مثال چند نوشته قبلی این سری نوشته‌ها را پی خواهیم گرفت. نیازمندی نرم‌افزاری را در روز دوازدهم از Stub بیان کردیم. به عنوان بخشی از این نیازمندی، ما باید با یک سیستم ثبت سفارش خارجی ارتباط برقرار کنیم. تست کیس بعدی که می‌خواهم به آن بپردازم مربوط به همین ارتباط با سیستم خارجی ثبت سفارش است. به جای اینکه خودمان بخش ثبت سفارش را بنویسیم، مدیریت تصمیم گرفته که آن را برون‌سپاری (outsource) کنیم." />
    <meta name="twitter:image" content="http://elmah.ir/oldimg/tdd_cycle.jpg" />
  




<meta name="generator" content="Hugo 0.27.1" />


<link rel="canonical" href="http://elmah.ir/post/120-%DB%B3%DB%B0-%D8%B1%D9%88%D8%B2-%D8%A8%D8%A7-tdd--%D8%B1%D9%88%D8%B2-%D8%B4%D8%A7%D9%86%D8%B2%D8%AF%D9%87%D9%85--%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87-%D8%A7%D8%B2-%D9%BE%D8%A7%D8%B1%D8%A7%D9%85%D8%AA%D8%B1%D9%87%D8%A7%DB%8C-%D9%85%D8%B4%D8%AE%D8%B5-%D8%AF%D8%B1-stub-%D9%87%D8%A7/" />
<link rel="alternative" href="http://elmah.ir/index.xml" title="elmah" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />







<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="elmah" />
<meta name="msapplication-tooltip" content="elmah" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="http://elmah.ir/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="http://elmah.ir/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="http://elmah.ir/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="http://elmah.ir/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="http://elmah.ir/img/touch-icon-apple.png" />
<link rel="mask-icon" href="http://elmah.ir/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="http://elmah.ir/css/bundle.css" />
<link rel="stylesheet" href="http://elmah.ir/css/elmah.css" />

  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="https://avatars1.githubusercontent.com/u/1385656?s=460&amp;v=4" alt="Avatar">
  
  <h2 class="title">elmah</h2>
  
  <p class="subtitle">~ یادداشت‌های یک برنامه‌نویس خوشحال ~</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item  is-active"><a href="http://elmah.ir/">صفحه نخست</a></li>
      
        <li class="menu-item "><a href="https://hameds.github.io/slides/">پرزنت‌های من</a></li>
      
        <li class="menu-item "><a href="http://elmah.ir/about/">درباره من</a></li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      

      
      <li class="social-item">
        <a href="//github.com/hameds" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      <li class="social-item">
        <a href="//twitter.com/hamed" title="Twitter"><span class="icon icon-twitter"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="http://elmah.ir/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">۳۰ روز با TDD: روز شانزدهم- استفاده از پارامترهای مشخص در Stub ها</h1>
      <p class="post-meta">@حامد سعیدی فرد · 4 دقیقه خواندن</p>
    </header>
    <article class="post-content"><p>ما مثال چند نوشته قبلی این سری نوشته‌ها را پی خواهیم گرفت. نیازمندی نرم‌افزاری را در <a href="http://elmah.ir/post/107-۳۰-روز-با-tdd--روز-دوازدهم---کار-با-stub-ها/">روز دوازدهم</a> از Stub بیان کردیم. به عنوان بخشی از این نیازمندی، ما باید با یک سیستم ثبت سفارش خارجی ارتباط برقرار کنیم. تست کیس بعدی که می‌خواهم به آن بپردازم مربوط به همین ارتباط با سیستم خارجی ثبت سفارش است. به جای اینکه خودمان بخش ثبت سفارش را بنویسیم، مدیریت تصمیم گرفته که آن را برون‌سپاری (outsource) کنیم. این تصمیم به آن معنی است که برای بخش ثبت سفارش باید با یک وب سرویس خارج از نرم‌افزار اصلی ارتباط برقرار کنیم. همچنین برای این ارتباط باید بخشی از اطلاعات مشتری (حداقل نام و آدرس) را آماده کنیم.</p>

<p>برای ارائه اطلاعات مشتری (اعم از نام و آدرس) CustomerService می‌بایست تغییر کند.</p>

<script src="//gist.github.com/hameds/2551998cd8b80242bded70b1e9fd0a42.js"></script>

<p>سپس به یک Interface برای Customer Service نیاز داریم</p>

<script src="//gist.github.com/hameds/9a6db0a5779c72288e63c7cab6539968.js"></script>

<p>هم تعریف Entity و هم Interface مربوط به Customer Service را به پروژه TddStore.Core اضافه می‌کنیم.</p>

<p>در این قسمت باید از اولین تست کیس مربوط به تعامل با OrderFulfillment Service صحبت کنم که جالب است بدانید هیچ ارتباطی با خود OrderFulfillment ندارد! در این مورد می‌خواهم مطمئن شوم که OrderService به درستی از CustomerService استفاده می‌کند.</p>

<p>صورت مساله تست: وقتی یک مشتری معتبر سفارشی را ثبت می‌کند (که اعتبارسنجی آن انجام شده) این سفارش ثبت شده و یک شناسه سفارش برگردانده می‌شود</p>

<p>به یک تست جدید نیاز دارم:</p>

<script src="//gist.github.com/hameds/53af128f910502dd5aff1ccc60426f6d.js"></script>

<p>بلی! این شبیه شروع تست WhenUserPlacesACorrectOrderThenAnOrderNumberShouldBeReturned  به نظر می‌رسد و خیر! نباید WhenUserPlacesACorrectOrderThenAnOrderNumberShouldBeReturned را تغییر دهیم که در کنار تست اصلی، تعامل با CustomService را نیز تست کند.</p>

<p>هدف تست اصلی این است که تعامل با OrderDataSevice به درستی کار می‌کند. جزئیات این تعامل بسته به اینکه متد چطور با CustomerService کار می‌کند ممکن است متفاوت باشد. با تکامل این تست‌ها، نیاز به mock‌های بیشتر OrderDataService حس می‌شود. این باعث می‌شود که هر دو تعامل (از OrderService به OrderDataService و از OrderService به CustomerService) تقریباً مستقل از هم تغییر کنند که باعث تولید تست‌های شکننده کمتری می‌شود. همچنین با استفاده از این روش، چنانچه تستی fail شود دقیقاً خواهم دانست که آیا ارتباط بین OrderDataService و CustomerService باعث این fail شده یا خیر.</p>

<p>قبل از اینکه جلوتر برویم، لازم است وهله (instance) از mock مربوط به CustomerService را در کلاس OrderServiceTests معرفی کنم. همچنین باید از SetupTestFixture نیز استفاده کنم.</p>

<script src="//gist.github.com/hameds/9ac4961d45cbbee46d7df92455ad810b.js"></script>

<p>می‌دانم که برای نیازمندی مطرح شده در OrderFultillment باید مشتری را از CustomerService بازیابی (retrieve) کنم. در حال حاضر mock مربوط به CustomerService را تعریف کرده‌ام، پس حالا باید arrange انجام شود. در این مورد می‌خواهم stub من یک مشتری مشخص را وقتی که GetCustomer با پارامتر خاصی فراخوانی می‌شود برگرداند.</p>

<script src="//gist.github.com/hameds/4b2a8a57688e2f0210f90ad0d889e0a6.js"></script>

<p>در ایجاد شی customerToReturn من شی Customer را با Id و نام و نام خانوادگی پر کردم. از نظر فنی در حال حاضر نیازی به نام و نام خانوادگی در این شی ندارم، اما می‌خواهم تا جای ممکن فیلدهای بیشتری را برای تست پر کنم. حالا که ورودی و خروجی تعریف شده‌اند، می‌توانم stub را arrange کنم. در این مورد فقط می‌خوام تا stub مربوط به CustomerService مقدار cutsomterToReturn را وقتی که GetCustomer با پارامتر CustomerId فراخوانی می‌شود برگرداند. همچنین انتظار دارم این متد تنها یک بار فراخوانی شود</p>

<script src="//gist.github.com/hameds/37898dd20a015f5daf83c902b501d46d.js"></script>

<p>در پایان لازم است فراخوانی صحیح mock جدید را با assert چک کنم. این کار را با فراخوانی Mock.Assert و پاس دادن mock مربوط به CustomerService می‌توانم انجام بدهم.</p>

<script src="//gist.github.com/hameds/c7ef02374018b2160a050a1c92b4af2e.js"></script>

<p>همانطور که انتظار داریم تست هنگام اجرا fail می‌شود</p>

<p><img src="http://elmah.ir/oldimg/image_thumb10f068238bf23-png.png" alt="" /></p>

<p>کد stub‌ مربوط به CustomerService من فراخوانی نشده. باید به متد PlaceOrder در کلاس OrderService بروم و منطق فراخوانی CustomerService را پیاده سازی کنم.</p>

<script src="//gist.github.com/hameds/692b7c41f82a6ad1f2cb9486851ae3d5.js"></script>

<p>در این قسمت نمی‌توانم کدم را اجرا کنم چون کامپایل نمی‌شود. ارجاع (reference) به CustomerService در کلاس OrderService ندارم. پس گام بعدی تغییر OrderService برای پذیرش ICustomerService به عنوان یک وابستگی است که از طریق سازنده (constructor) آن را تزریق می‌کنم (برای این تغییر کد راحت‌تر باشد متد PlaceOrder را از نمونه کد زیر برداشتم)</p>

<script src="//gist.github.com/hameds/6e031a2d866c0666b4b3966798a1fe8d.js"></script>

<p>اجرای مجدد تست‌ها نشان می‌دهد که کد همچنان کامپایل نمی‌شود. دلیلش این است که در متد SetupTestFixture کلاس OrderServiceTests تلاش می‌کنیم وهله (instance) از OrderService بدون پاس دادن ICustomerService به سازنده (constrcutor) کلاس بسازیم. برای این کار متد را برای تامین mock در سازنده OrderService تغییر دادم (برای مشاهده راحت‌تر تغییر کد، using ها و متدهای تست را از کلاس برداشتم)</p>

<script src="//gist.github.com/hameds/357e6bd138c9c50c9e078e07d936ba43.js"></script>

<p>حالا تست آماده اجراست و همانطور که در تصویر زیر مشخص است، pass می‌شود.</p>

<p><img src="http://elmah.ir/oldimg/image_thumb3d3df4781c285-png.png" alt="" /></p>

<p>چیزی که ممکن است سوال کنید این است که چرا مشابه تست اصلی، نتیجه فراخوانی PlaceOrder را دریافت و آزمایش نکردیم. دلیلش این است که در این تست، ما اهمیتی به شماره سفارش نمی‌دهیم و فقط تعامل با CustomerService را مورد آزمایش قرار می‌دهیم.</p>

<p>ادامه دارد&hellip;.</p>
</article>
    <footer class="post-footer">
      
      <p class="post-copyright">       
        این نوشته  <strong>723</strong> روز پیش منتشر شده و محتوای آن ممکن است برای امروز، غیردقیق یا حتی اشتباه باشد. اگر اشتباهی دیدید لطفاً در گیت‌هاب اعلام یا رفعش کنید.
      </p>
    </footer>
    <hr>
    <div id="darinternet_comment"></div>
    <script type="text/javascript">    
      (function () {
        var cmt = document.createElement('script');
        cmt.type = 'text/javascript';
        cmt.async = true;
        cmt.src = 'https://www.darinternet.com/script/commentscript/ccc91a81-b2c4-e711-90f9-005056000124';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(cmt);
      })();
    </script>
    
    
      
    
  </section>
  <footer class="site-footer">
  <p>© 2017 elmah</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\[','\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="http://elmah.ir/js/bundle.js"></script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-109151384-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>





  </body>
</html>
